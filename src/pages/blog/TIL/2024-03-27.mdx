---
title: "[RN] iOS 인앱 결제 기능넣기 2️⃣"
date: 2024-03-27 13:03:24
category: til
thumbnail: "react"
description: '지난번에 이어, react-native-iap 사용하여 어떻게 코드를 작성해야 하는 지 알아보자.'
draft: true
---

import Layout from '/src/templates/blog-post';
export default Layout;

## 개요

지난 포스팅에서는 iOS 인앱 결제 기능을 넣기 위한 준비 작업을 진행했다. 이번에는 `react-native-iap` 라이브러리를 사용하여 어떻게 코드를 작성해야 하는 지 알아보자.


### 프로젝트 생성

프로젝트를 생성한다. 테스트 환경은 다음과 같다.

```
[iOS]
- ruby: 2.7.8
- cocoapods: 1.15.2

[JS]
- react-native: 0.73.6
- react-native-iap: `12.13.0`
```


<Callout variant="info">
  <b>🤔 `ruby`와 `cocoapods`이란?</b>
  <br />

  사실 RN 개발자라면 무엇인지 아실 테지만, 이들은 iOS 환경 설정, 앱의 의존성과 관련되어 있다.
  <br />
  ruby는 프로그래밍 언어로, iOS 개발에 직접적으로 사용되는 언어는 아니다. (직접적으로 사용되는 언어는 objective-c, swift) 하지만 cocoapods이 ruby로 작성되었기 때문에, cocoapods을 사용하기 위해서는 반드시 ruby가 설치되어야 한다.

  JS로 비교하자면, node.js와 비슷한 역할을 담당한다고 생각하면 된다.
  <br />
  cocoapods는 iOS 앱의 의존성 관리자이다. 카메라, 인앱 결제, 위치기반 서비스 등의 iOS 네이티브 기능을 지원하는 라이브러리를 사용하고 싶다면, 아무리 개발 환경이 RN이라고 해도 cocoapods를 사용해서 해당 라이브러리를 관리해야 한다.

  JS로 비교하자면, NPM과 비슷한 역할을 담당한다고 생각하면 된다.
</Callout>

`App.tsx` 파일을 다음과 같이 작성한다.


```tsx
import {
  IapIosSk2,
  initConnection,
  ProductPurchase,
  requestPurchase,
  setup,
  useIAP,
  withIAPContext,
} from 'react-native-iap';

const ITEM_SKUS = [
  'new.item1',
  'new.item2',
  'new.item3',
  'new.item4',
  'phg_item',
  'phg_item2',
  'phg_item3',
  'green_item',
];

function App(): React.JSX.Element {
  const { products, getProducts, finishTransaction, currentPurchase } = useIAP();

  const buy = async (sku: string) => {
    try {
      const result = await requestPurchase({
        sku,
        andDangerouslyFinishTransactionAutomaticallyIOS: false,
      });
      console.log(result);
    } catch (err) {
      console.error(err);
    }
  };

  const refund = async (sku: string) => {
    try {
      const result = await IapIosSk2.beginRefundRequest(sku); // 'success' | 'userCancelled'
      console.log(result);
    } catch (err) {
      console.error(err);
    }
  };

  useEffect(() => {
    (async () => {
      setup({storekitMode: 'STOREKIT2_MODE'});

      await initConnection();
      await getProducts({skus: ITEM_SKUS});
    })();
  }, [getProducts]);

  useEffect(() => {
    const checkCurrentPurchase = async (
      purchase: ProductPurchase,
    ): Promise<void> => {
      if (purchase) {
        try {
          console.log(JSON.stringify(purchase, null, 2));
          const ackResult = await finishTransaction({purchase});
          console.log(JSON.stringify(ackResult, null, 2));
        } catch (err) {
          console.error(err);
        }
      }
    };

    if (currentPurchase) {
      checkCurrentPurchase(currentPurchase);
    }
  }, [currentPurchase, finishTransaction]);

  return (
    <SafeAreaView>
      <StatusBar />
      <FlatList
        data={ITEM_SKUS}
        keyExtractor={item => item}
        renderItem={({item: sku}) => (
          <View>
            <Button title={`${sku} 구매하기`} onPress={() => buy(sku)} />
            <Button title={`${sku} 환불하기`} onPress={() => refund(sku)} />
          </View>
        )}
      />
    </SafeAreaView>
  );
}

export default withIAPContext(App);
```

위 코드에서 편의상 스타일과 관련된 코드는 제거했지만, UI는 다음과 같이 만들어 주었다.




