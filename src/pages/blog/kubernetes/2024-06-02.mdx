---
title: "[K8S] í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œìì˜ EKS ê²½í—˜ê¸° 4ï¸âƒ£"
date: 2024-06-02 13:06:12
category: kubernetes
thumbnail: 'k8s'
description: 'ë“œë””ì–´ í¬ìŠ¤íŠ¸ë¥¼ ë§ˆë¬´ë¦¬í–ˆë‹¤...'
draft: false
---

import Layout from '/src/templates/blog-post';
export default Layout;

![](https://i.imgur.com/WGnU0ZA.png)

[ì§€ë‚œ í¬ìŠ¤íŠ¸](/blog/kubernetes/2024-04-27/)ì—ì„œëŠ” í´ëŸ¬ìŠ¤í„°ë¥¼ ìƒì„±í•˜ê³ , ê°€ì¥ ê¸°ë³¸ì ì¸ ë¦¬ì†ŒìŠ¤ ìœ í˜•ì¸ `Deployment`ì™€ `Service`ë¥¼ ì •ì˜í•œ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ì„ ì‘ì„±í•´ë³´ì•˜ë‹¤.

ì´ë²ˆì—ëŠ” `istio`ì™€ ê´€ë ¨ëœ ë¦¬ì†ŒìŠ¤ì¸ `Gateway`, `VirtualService`ë¥¼ í¬í•¨í•œ ë‚˜ë¨¸ì§€ ì‘ì—…ì„ ì „ë¶€ ë§ˆë¬´ë¦¬í•˜ì—¬, ìµœì¢…ì ìœ¼ë¡œ ë°°í¬ ìë™í™”ë¥¼ ë‹¬ì„±í•´ë³´ì.

<Callout variant="warning">
  <b>ğŸš¨ ê²½ê³ , ì „ë¬¸ì„±ì´ ë†’ì§€ ì•Šì€ ê¸€ì…ë‹ˆë‹¤!</b>
  <br />
  <br />
  ì‹¤ì œ devOps ê°œë°œì ë¶„ë“¤ í˜¹ì€ í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ì— ì¼ê°€ê²¬ì´ ìˆìœ¼ì‹  ë¶„ë“¤ì€ ì œ ê¸€ì„ ë³´ê³  ì˜ë¬¸ì„ í’ˆëŠ” ë¶€ë¶„ì´ í•œë‘ ê³³ì´ ì•„ë‹ˆì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
  - <u>"ì™œ externalDNSë¥¼ ì‚¬ìš©í•˜ì§€?"</u>
  - <u>"ì‚¬ì´ë“œì¹´ ì¸ì ì…˜ë„ ëª¨ë¥´ëŠ”ë° istioëŠ” ì™œ ì‚¬ìš©í•˜ëŠ” ê±°ì§€?"</u>
  - <u>"vpcê°€ ë­”ì§€ëŠ” ì•Œê³  ê¸€ì„ ì“°ëŠ”ê±´ê°€ ì´ì‚¬ëŒ?"</u>

  ì—¬ëŸ¬ë¶„ë“¤ì˜ ì˜ê²¬ì´ ì „ë¶€ ë§ìŠµë‹ˆë‹¤. ì €ëŠ” <b>í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œì</b>ì´ë©°, ë‹¨ìˆœíˆ íšŒì‚¬ì˜ k8s ì¸í”„ë¼ê°€ ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ë™ì‘í•˜ëŠ” ì§€ ë„ˆë¬´ë‚˜ë„ ê¶ê¸ˆí•˜ì—¬, íšŒì‚¬ì—ì„œ êµ¬ì¶•í•œ ë°©ì‹ì„ ê¸°ì¤€ìœ¼ë¡œ ì„¤ëª…ì„ í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.
  <br />
  ì œ ìˆ˜ì¤€ì—ì„œ ì„¤ëª…ì„ í•  ìˆ˜ ìˆëŠ” ë¶€ë¶„(ì™œ spot ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì‚¬ìš©í–ˆëŠ”ê°€?)ì€ ì„¤ëª…í•˜ê² ì§€ë§Œ, ë„ˆë¬´ deepí•´ì§€ëŠ” ë¶€ë¶„ë“¤(ex. istioëŠ” ë¬´ì—‡ì´ë©°, ì™œ ì‚¬ìš©í•˜ëŠ”ê°€?)ì€ ì œ ìˆ˜ì¤€ì„ ë²—ì–´ë‚˜ëŠ” ì£¼ì œê°€ ë˜ì–´ì„œ ë¶€ë“ì´ ìƒëµí•˜ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤. ğŸ™‡
</Callout>

## íŠ¸ë˜í”½ íë¦„ ì´í•´í•˜ê¸°

![](https://i.imgur.com/o6AXiQh.png)
> ì´ë¯¸ì§€ ì¶œì²˜ : [aws-eks-istio-lab](https://github.com/junglekid/aws-eks-istio-lab)

ìœ„ ì´ë¯¸ì§€ëŠ” EKS í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ íŠ¸ë˜í”½ì´ ì–´ë–»ê²Œ íë¥´ëŠ” ì§€ë¥¼ ë³´ì—¬ì¤€ë‹¤.

1. ìœ ì €ê°€ ë„ë©”ì¸ì— ì ‘ê·¼í•œë‹¤.
2. AWS DNS ì„œë¹„ìŠ¤ì¸ Route53ì´ ë„ë©”ì¸ì„ ë¡œë“œë°¸ëŸ°ì„œì¸ ALBë¡œ ë¼ìš°íŒ…í•œë‹¤.
3. ALBëŠ” íŠ¸ë˜í”½ì„ EKS í´ëŸ¬ìŠ¤í„°ì˜ `istio-ingressgateway`ë¡œ ì „ë‹¬í•œë‹¤.
4. `istio-ingressgateway`ëŠ” íŠ¸ë˜í”½ì„ `Gateway`ë¡œ ì „ë‹¬í•œë‹¤.
5. `Gateway`ëŠ” íŠ¸ë˜í”½ì„ `VirtualService`ë¡œ ì „ë‹¬í•œë‹¤.
6. `VirtualService`ëŠ” íŠ¸ë˜í”½ì„ `Service`ë¡œ ì „ë‹¬í•œë‹¤.
7. `Service`ëŠ” í•´ë‹¹ íŠ¸ë˜í”½ì„ `Pod`ë¡œ ì „ë‹¬í•œë‹¤.
8. `Pod`ëŠ” ìµœì¢…ì ìœ¼ë¡œ ì‚¬ìš©ìì—ê²Œ í•´ë‹¹ í˜ì´ì§€ë¥¼ ì‘ë‹µí•œë‹¤.

ìœ„ì™€ ê°™ì€ íë¦„ìœ¼ë¡œ íŠ¸ë˜í”½ì´ ì²˜ë¦¬ë˜ë„ë¡ í•˜ê¸° ìœ„í•´, ë‚˜ëŠ” <u><strong>ë‹¤ìŒ ìˆœì„œ</strong>ë¡œ ì‘ì—…ì„ ì§„í–‰</u>í•  ê²ƒì´ë‹¤.

1. ALB ì„¤ì¹˜
2. Istio ì„¤ì¹˜
3. ExternalDNS ë°°í¬
4. Ingress ë°°í¬
5. Gateway, VirtualService ë°°í¬

## 1ï¸âƒ£ ALB ì„¤ì¹˜

ALBëŠ” AWSì—ì„œ ì œê³µí•˜ëŠ” ë¡œë“œë°¸ëŸ°ì„œ ì„œë¹„ìŠ¤ë¡œ, í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì—ì„œ í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ë¡œ íŠ¸ë˜í”½ì„ ì „ë‹¬í•˜ëŠ” ì—­í• ì„ í•œë‹¤.

ì„¤ì¹˜í•˜ëŠ” ë°©ë²•ì€ ì—¬ëŸ¬ê°€ì§€ê°€ ìˆê² ì§€ë§Œ, AWSì—ì„œ ì´ˆì‹¬ìëŠ” [`helm`ì„ ì‚¬ìš©í•´ì„œ ì„¤ì¹˜](https://docs.aws.amazon.com/ko_kr/eks/latest/userguide/lbc-helm.html)í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•˜ë¯€ë¡œ, ì´ë¥¼ ë”°ë¼í•˜ê¸°ë¡œ í–ˆë‹¤.

<Callout variant="info">
  <b>ğŸ¤” `helm`ì´ë€?</b>
  ![](https://i.imgur.com/LfbiSE6.png)
  <br />
  <br />
  Node.jsì—ëŠ” NPMì´ ìˆë“¯ì´, Kubernetesì—ëŠ” [Helm](https://helm.sh/)ì´ë¼ëŠ” **íŒ¨í‚¤ì§€ ë§¤ë‹ˆì €**ê°€ ìˆë‹¤.
  ë”°ë¼ì„œ NPMì˜ `npm install` ëª…ë ¹ì–´ì™€ ë¹„ìŠ·í•˜ê²Œ `helm install` ëª…ë ¹ì–´ë¡œ í´ëŸ¬ìŠ¤í„°ì— í•„ìš”í•œ ì˜ì¡´ì„±ì„ ì‰½ê²Œ ì„¤ì¹˜í•  ìˆ˜ ìˆë‹¤.
  <br />

  macOSì—ì„œëŠ” `brew install helm`ìœ¼ë¡œ ê°„ë‹¨íˆ ì„¤ì¹˜í•  ìˆ˜ ìˆë‹¤.
</Callout>

### 1. Service Accountì— ëŒ€í•œ IAM ì—­í•  ìƒì„±

```bash
curl -O https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/v2.7.2/docs/install/iam_policy.json
```

ìœ„ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•´ì„œ IAM ì •ì±… íŒŒì¼ì¸ `iam_policy.json`ì„ í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬ë¡œ ë‹¤ìš´ë¡œë“œí•œë‹¤.

```bash
aws iam create-policy \
    --policy-name AWSLoadBalancerControllerIAMPolicy \ # 1ï¸âƒ£ ì •ì±… ì´ë¦„
    --policy-document file://iam_policy.json           # 2ï¸âƒ£ ì •ì±… íŒŒì¼
```

ì´í›„ ìœ„ `aws` ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì—¬ IAM ì •ì±…ì„ ìƒì„±í•˜ì.

![](https://i.imgur.com/oOLWLag.png)
> ì •ìƒì ìœ¼ë¡œ ìƒì„±ëœ IAM ì •ì±… `AWSLoadBalancerControllerIAMPolicy`

IAM ì •ì±…ì„ ìƒì„±í–ˆë‹¤ë©´ ì´ì œ eksctl ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•´ì„œ IAM ì—­í• ì„ ìƒì„±í•œë‹¤.

```yaml
eksctl create iamserviceaccount \
  --cluster=greenhead-cluster \ # í´ëŸ¬ìŠ¤í„° ì´ë¦„
  --namespace=kube-system \
  --name=aws-load-balancer-controller \
  --role-name AmazonEKSLoadBalancerControllerRole \
  --attach-policy-arn=arn:aws:iam::971490215356:policy/AWSLoadBalancerControllerIAMPolicy \
  --approve # ëª…ë ¹ì–´ ì‹¤í–‰ í›„ ë³„ë„ ìŠ¹ì¸ê³¼ì • ì—†ì´ ë°”ë¡œ ì„œë¹„ìŠ¤ ê³„ì • ì‚¬ìš©
```
> --attach-policy-arnì—ì„œ `971490215356`ì€ ë‚´ AWS ê³„ì • IDë¥¼ ì˜ë¯¸í•œë‹¤.

### 2. AWS Load Balancer Controller ì„¤ì¹˜

```bash
# 1ï¸âƒ£ eks-charts ë ˆí¬ì§€í† ë¦¬ë¥¼ ë¡œì»¬ì— ì¶”ê°€
$ helm repo add eks https://aws.github.io/eks-charts
# npmê³¼ ë‹¬ë¦¬, helmì—ì„œëŠ” ë¦¬ì†ŒìŠ¤ë¥¼ ì„¤ì¹˜í•˜ë ¤ë©´ ìš°ì„  ì„¤ì¹˜í•˜ë ¤ëŠ” ë ˆí¬ì§€í† ë¦¬ë¥¼ ë¡œì»¬ì— ë“±ë¡í•´ì¤˜ì•¼ í•œë‹¤.

# 2ï¸âƒ£ ë“±ë¡í•œ ë¡œì»¬ ë ˆí¬ì§€í† ë¦¬ ìµœì‹ í™”
$ helm repo update eks

# 3ï¸âƒ£ helmìœ¼ë¡œ ALB ì„¤ì¹˜
$ helm install aws-load-balancer-controller eks/aws-load-balancer-controller \
  -n kube-system \ # ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ëª…ì‹œ
  --set clusterName=greenhead-cluster \
  --set serviceAccount.create=false \ # ì „ ë‹¨ê³„ì—ì„œ ì„œë¹„ìŠ¤ ê³„ì •ì„ ì´ë¯¸ ìƒì„±í•˜ì˜€ìœ¼ë¯€ë¡œ ìƒëµ
  --set serviceAccount.name=aws-load-balancer-controller
```

ìœ„ ëª…ë ¹ì–´ë“¤ì´ ì „ë¶€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë˜ì—ˆë‹¤ë©´, ì•„ë˜ ëª…ë ¹ì–´ë¥¼ í†µí•´ ì»¨íŠ¸ë¡¤ëŸ¬ê°€ ì„¤ì¹˜ë˜ì—ˆëŠ” ì§€ í™•ì¸í•˜ì.

```bash
$ kubectl get deployment -n kube-system aws-load-balancer-controller

# ë‹¤ìŒê³¼ ê°™ì´ ì¶œë ¥ë˜ë©´ ì •ìƒì ìœ¼ë¡œ ì„¤ì¹˜ëœ ê²ƒì´ë‹¤.
NAME                           READY   UP-TO-DATE   AVAILABLE   AGE
aws-load-balancer-controller   2/2     2            2           47d
```

## 2ï¸âƒ£ Istio ì„¤ì¹˜

[Google Cloudì—ì„œ ì„¤ëª…í•˜ëŠ” Istioì˜ ì •ì˜](https://cloud.google.com/learn/what-is-istio?hl=ko)ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

> <i>"IstioëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ ë„¤íŠ¸ì›Œí¬ ê¸°ëŠ¥ì„ ìœ ì—°í•˜ê³  ì‰½ê²Œ ìë™í™”í•  ìˆ˜ ìˆëŠ” íˆ¬ëª…í•œ ì–¸ì–´ ë…ë¦½ì  ë°©ë²•ì„ ì œê³µí•˜ëŠ” í˜„ëŒ€í™”ëœ ì„œë¹„ìŠ¤ ë„¤íŠ¸ì›Œí‚¹ ë ˆì´ì–´ì¸ ì„œë¹„ìŠ¤ ë©”ì‹œì…ë‹ˆë‹¤."</i>

í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œìì¸ ë‚˜ë¡œì„œëŠ” ë„ë¬´ì§€ í•´ë‹¹ ë¬¸ì¥ì„ ì´í•´í•  ìˆ˜ ì—†ì—ˆë‹¤...

![](https://i.imgur.com/AtIRUmm.png)

Istioê°€ ë¬´ì—‡ì¸ì§€ ì •í™•íˆ ì´í•´í•˜ë ¤ë©´ <strong>ì ì§€ ì•Šì€ ì‹œê°„</strong>ì„ ì¨ì•¼ í•  ê²ƒ ê°™ë‹¤ê³  ëŠê¼ˆê¸°ì—, ë‚˜ëŠ” ì•ì˜ <strong>`íŠ¸ë˜í”½ íë¦„ ì´í•´í•˜ê¸°`</strong> ì„¹ì…˜ì—ì„œ istioê°€ ì–´ë–»ê²Œ ì‚¬ìš©ë˜ì—ˆëŠ” ì§€ë¥¼ ì°¸ê³ í•˜ì—¬ istioë¥¼ <u>"í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì—ì„œ ë‚´ë¶€ë¡œ ë“¤ì–´ì˜¤ëŠ” íŠ¸ë˜í”½ì„ ê´€ë¦¬í•˜ëŠ” ë„êµ¬"</u>ë¡œ ê°„ë‹¨íˆ ìƒê°í•˜ê¸°ë¡œ í•˜ì˜€ë‹¤.

<Callout variant="warning">
  ë” ì •í™•í•œ ë‚´ìš©ì€ [Istio ê³µì‹ ë¬¸ì„œ](https://istio.io/latest/)ì—ì„œ ì„¤ëª…í•˜ëŠ” ë‚´ìš©ì„ ì°¸ê³ í•˜ì...
</Callout>

í´ëŸ¬ìŠ¤í„°ì— Istio`ë¥¼ ì„¤ì¹˜í•˜ê¸° ìœ„í•´ ë‚˜ëŠ” CLI ë„êµ¬ì¸ `istioctl`ì„ ì‚¬ìš©í•  ê²ƒì´ë‹¤. Homebrewë¡œ ê°„ë‹¨íˆ ì„¤ì¹˜í•  ìˆ˜ ìˆë‹¤.

ë‹¤ìŒ `istioctl` ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ì—¬ Istio í´ëŸ¬ìŠ¤í„°ì— ì„¤ì¹˜í•œë‹¤.

```bash
istioctl install --set profile=default # istio-system ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ì„¤ì¹˜ëœë‹¤.
```

<Callout variant="info">
  <b>ğŸ¤” `profile` ì†ì„±ì´ ì˜ë¯¸í•˜ëŠ” ê²ƒì€?</b>
  <br />
  <br />
  ![](https://i.imgur.com/czXUEHb.png)

  `profile` ì†ì„±ì„ ëª…ì‹œí•¨ìœ¼ë¡œì¨ íŠ¹ì • istioì˜ êµ¬ì„± ìš”ì†Œë¥¼ í¬í•¨ì‹œí‚¤ê±°ë‚˜ ì œì™¸í•˜ì—¬ istioë¥¼ ì„¤ì¹˜í•  ìˆ˜ ìˆë‹¤. istioì˜ ì£¼ìš” êµ¬ì„± ìš”ì†Œ ì¤‘ <u>ê°€ì¥ ì¤‘ìš”í•œ 3ê°€ì§€</u>ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.
  <br />

  - `istio-egressgateway`: í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ -> ë‚´ë¶€ë¡œ ë“¤ì–´ì˜¤ëŠ” íŠ¸ë˜í”½ ê´€ë¦¬
  - <strong>`istio-ingressgateway`</strong>: í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ -> ì™¸ë¶€ë¡œ ë“¤ì–´ì˜¤ëŠ” íŠ¸ë˜í”½ ê´€ë¦¬
  - <strong>`istiod`</strong>: istio í•µì‹¬ êµ¬ì„±ìš”ì†Œ
  <br />
  ë‚˜ì˜ í´ëŸ¬ìŠ¤í„°ê°€ ì •ìƒ ë™ì‘í•˜ë ¤ë©´ <strong>`istio-ingressgateway`</strong>, <strong>`istiod`</strong>ê°€ í•„ìš”í•˜ë¯€ë¡œ `profile`ì„ `default`ë¡œ í•˜ì—¬ istioë¥¼ ì„¤ì¹˜í•œë‹¤.
</Callout>

<Callout variant="tip">
  `istioctl`ì˜ `profile` ê´€ë ¨í•˜ì—¬ ì¢€ ë” ìì„¸í•œ ë‚´ìš©ì€ [ì—¬ê¸° í¬ìŠ¤íŠ¸](https://kingofbackend.tistory.com/244)ì—ì„œ í•œêµ­ì¸ ê°œë°œìë¶„ê»˜ì„œ ì´í•´í•˜ê¸° ì‰½ê²Œ ì‘ì„±í•´ ì£¼ì…¨ë‹¤.
</Callout>

ì´ë•Œ ì„¤ì¹˜ëœ `istio-ingressgateway`ì˜ Typeì€ `Loadbalancer`ì¸ë°, ì´ ê²½ìš° ìë™ìœ¼ë¡œ ì™¸ë¶€ ë¡œë“œë°¸ëŸ°ì„œë¥¼ ìƒì„±í•˜ê²Œ ëœë‹¤. ë‚˜ì˜ ê²½ìš° ì•ì—ì„œ ì„¤ì¹˜í•œ <strong>ALBê°€ ê´€ë¦¬í•˜ëŠ” ë¡œë“œë°¸ëŸ°ì„œ</strong>ë¥¼ ì‚¬ìš©í•  ê²ƒì´ë¯€ë¡œ, `istio-ingressgateway`ì˜ `Type`ì„ `NodePort`ë¡œ ë³€ê²½í•˜ì—¬ <u>ë¶ˆí•„ìš”í•˜ê²Œ ë¡œë“œë°¸ëŸ°ì„œê°€ ìƒì„±ë˜ì§€ ì•Šë„ë¡</u> í•  í•„ìš”ê°€ ìˆë‹¤.

```bash
kubectl edit -n istio-system service istio-ingressgateway
```

ìœ„ ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ë©´ `istio-ingressgateway`ì˜ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ì„ <strong>ì“°ê¸° ëª¨ë“œ</strong>ë¡œ ì—´ ìˆ˜ ìˆë‹¤. ì•„ë˜ì™€ ê°™ì´ ìˆ˜ì •í•˜ì.

```bash
spec:
  ...
  type: NodePort # Loadbalancerë¡œ ë˜ì–´ ìˆì„ í…ë°, NodePortë¡œ ìˆ˜ì •í•˜ê¸°
  ...
```

## 3ï¸âƒ£ ExternalDNS ë°°í¬

![](https://i.imgur.com/TTEPJTf.png)

<strong>ExternalDNS</strong>ëŠ” í´ëŸ¬ìŠ¤í„° ë‚´ì—ì„œ <u>DNS ë ˆì½”ë“œë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•˜ê³  ì—…ë°ì´íŠ¸</u>í•˜ëŠ” ë„êµ¬ì´ë‹¤. ì´ë¥¼ í†µí•´ ì¿ ë²„ë„¤í‹°ìŠ¤ ë¦¬ì†ŒìŠ¤ì¸ `Ingress` í˜¹ì€ `Service`ì˜ IP ì£¼ì†Œ ë˜ëŠ” LoadBalancer ì£¼ì†Œë¥¼ Route 53 ë“±ì˜ DNS ì œê³µìì— ìë™ìœ¼ë¡œ ë“±ë¡í•˜ì—¬, <u>ë„ë©”ì¸ ì´ë¦„ì„ í†µí•´ í´ëŸ¬ìŠ¤í„° ë‚´ ì„œë¹„ìŠ¤ì— ì ‘ê·¼</u>í•  ìˆ˜ ìˆê²Œ í•œë‹¤.

ì„¸ë¶€ì ì¸ ë‹¨ê³„ëŠ” ë‹¤ìŒê³¼ ê°™ìœ¼ë©°, [ExternalDNSì˜ ê³µì‹ íŠœí† ë¦¬ì–¼](https://github.com/kubernetes-sigs/external-dns/blob/master/docs/tutorials/aws.md)ì„ ì°¸ê³ í•˜ì—¬ ì§„í–‰í•˜ì˜€ë‹¤.

1. IAM ì •ì±… ìƒì„±
2. IAM ì—­í•  ìƒì„±
3. ExternalDNS ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì‘ì„± ë° ë°°í¬

<Callout variant="warning">
  <b>âš ï¸ ë„ë©”ì¸ ê´€ë ¨ëœ ì‘ì—…ì€ ì „ë¶€ ì™„ë£Œëœ ìƒíƒœë¼ ê°€ì •í•œë‹¤.</b>
  <br />
  <br />
  ![](https://i.imgur.com/7Gq7X1N.png)

  ë‚˜ì˜ ê²½ìš° `greenhead.blog` ë„ë©”ì¸ì´ ì´ë¯¸ Route 53ì— ë“±ë¡ë˜ì–´ ìˆê³ , HTTPS í†µì‹ ì„ ìœ„í•œ SSL ì¸ì¦ì„œë¥¼ ACMì„ í†µí•´ ìƒì„±ëœ ìƒíƒœì´ë‹¤.
</Callout>

### 1. IAM ì •ì±… ìƒì„±

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "route53:ChangeResourceRecordSets"
      ],
      "Resource": [
        "arn:aws:route53:::hostedzone/*"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "route53:ListHostedZones",
        "route53:ListResourceRecordSets",
        "route53:ListTagsForResource"
      ],
      "Resource": [
        "*"
      ]
    }
  ]
}
```
ìœ„ JSON ì½”ë“œë¥¼ `policy.json`ì´ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ì €ì¥í•œë‹¤. (ì´ë¦„ì€ ìƒê´€ì—†ë‹¤)

```bash
aws iam create-policy --policy-name "AllowExternalDNSUpdates" --policy-document file://policy.json
```

ì´í›„ ìœ„ `aws` ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì—¬ `AllowExternalDNSUpdates`ë¼ëŠ” ì´ë¦„ì˜ IAM ì •ì±…ì„ ìƒì„±í•˜ë©´ ëœë‹¤.

### 2. IAM ì—­í•  ìƒì„±

`eksctl` ëª…ë ¹ì–´ë¥¼ í†µí•´ <strong>IAM ì—­í• </strong>ì„ ìƒì„±í•œë‹¤.

```yaml
eksctl create iamserviceaccount \
  --name external-dns-green-blog-co \
  --namespace external-dns \
  --cluster greenhead-cluster \
  --attach-policy-arn arn:aws:iam::971490215356:policy/AllowExternalDNSUpdates \ # ì „ ë‹¨ê³„ì—ì„œ ìƒì„±í•œ IAM ì •ì±…ì— ëŒ€í•œ ARN ì…ë ¥
  --approve
```

### 3. ExternalDNS ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì‘ì„± ë° ë°°í¬

ì´ì œ ExternalDNS ê³µì‹ ë¬¸ì„œì˜ ["Manifest (for cluster with RABC enalbed)"](https://github.com/kubernetes-sigs/external-dns/blob/master/docs/tutorials/istio.md#manifest-for-clusters-with-rbac-enabled)ì— ì‘ì„±ëœ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ì„ ê¸°ì¤€ìœ¼ë¡œ ExternalDNS êµ¬ì„±ì„ ì‘ì„±í•˜ì—¬ í´ëŸ¬ìŠ¤í„°ì— ë°°í¬í•˜ë©´ ëœë‹¤.

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: external-dns-green-blog-co
rules:
  - apiGroups: [""]
    resources: ["services","endpoints","pods"]
    verbs: ["get","watch","list"]
  - apiGroups: ["extensions","networking.k8s.io"]
    resources: ["ingresses"]
    verbs: ["get","watch","list"]
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["list"]
  - apiGroups: ["networking.istio.io"]
    resources: ["gateways", "virtualservices"]
    verbs: ["get","watch","list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: external-dns-green-blog-co
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: external-dns-green-blog-co
subjects:
  - kind: ServiceAccount
    name: external-dns-green-blog-co
    namespace: external-dns
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: external-dns-green-blog-co
  namespace: external-dns
spec:
  selector:
    matchLabels:
      app: external-dns-green-blog-co
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: external-dns-green-blog-co
    spec:
      serviceAccountName: external-dns-green-blog-co
      containers:
        - name: external-dns-green-blog-co
          image: registry.k8s.io/external-dns/external-dns:v0.14.0
          args:
            - --source=service
            - --source=ingress
            - --source=istio-gateway
            - --source=istio-virtualservice
            - --domain-filter=green-blog.co # ë„ë©”ì¸ ì´ë¦„
            - --provider=aws
            - --policy=upsert-only
            - --aws-zone-type=public
            - --registry=txt
            - --txt-owner-id=Z06833101WGBT1HIY3N6H # í˜¸ìŠ¤íŒ… ì˜ì—­ ID
```

<Callout variant="info">
  <b>ğŸ“ ê°€ì¥ ì•„ë˜ `--txt-owner-id`ëŠ” Route 53ì˜ `í˜¸ìŠ¤íŒ… ì˜ì—­ ID` ê°’ì„ ì‚¬ìš©í•œë‹¤.</b>
  <br />
  <br />
  ![](https://i.imgur.com/ch4hDFW.png)
</Callout>

ì‘ì„±í•œ `yaml` íŒŒì¼ì„ `external-dns.yaml` ì´ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ì €ì¥í•˜ê³ , `kubectl` ëª…ë ¹ì–´ë¥¼ í†µí•´ í´ëŸ¬ìŠ¤í„°ì— ë°°í¬í•˜ë©´ ëœë‹¤.

```
kubectl apply -f external-dns.yaml
```

## 4ï¸âƒ£ Ingress ë°°í¬

<strong>`Ingress`</strong>ëŠ” ì´ì „ í¬ìŠ¤íŠ¸ì—ì„œ ë‹¤ë£¬ `Deployment`, `Serviceì™€` ê°™ì€ <strong>ì¿ ë²„ë„¤í‹°ìŠ¤ ë¹ŒíŠ¸ì¸ ë¦¬ì†ŒìŠ¤</strong> ì¤‘ í•˜ë‚˜ë¡œ, <u>ì¿ ë²„ë„¤í‹°ìŠ¤ ì™¸ë¶€ì—ì„œ ë‚´ë¶€ ì„œë¹„ìŠ¤ë¡œì˜ HTTP(S) íŠ¸ë˜í”½ì„ ë¼ìš°íŒ…</u>í•˜ëŠ” ì—­í• ì„ í•œë‹¤.

<strong>ë‹¤ë§Œ</strong> IngressëŠ” íŠ¸ë˜í”½ì„ ì–´ë–»ê²Œ ë¼ìš°íŒ…í•  ì§€ì— ëŒ€í•œ ê·œì¹™ì„ ì •ì˜í•˜ê¸°ë§Œ í•  ë¿, <u>ì‹¤ì œë¡œ íŠ¸ë˜í”½ì„ ì²˜ë¦¬í•˜ë ¤ë©´ <strong>Ingress Controller</strong>ë¼ëŠ” ê²ƒì´ í•„ìš”</u>í•˜ë‹¤. Nginx, Traefik ë“± ë‹¤ì–‘í•œ Ingress Controllerê°€ ì¡´ì¬í•œë‹¤ê³  í•˜ë©°, <u>ì „ ë‹¨ê³„ì—ì„œ ì„¤ì¹˜í•œ <strong>`istio-ingressgateway`</strong> ë˜í•œ Ingress Controller</u>ì´ë‹¤.

ì´ì œ Ingress ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ì„ ì‘ì„±í•´ë³´ì.


```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: istio-ingress-green-blog-co
  namespace: istio-system # istiod, istio-ingressgatewayê°€ ì„¤ì¹˜ëœ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¡œ ë§ì¶”ê¸°
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing # ALBë¥¼ ì™¸ë¶€ì— ë…¸ì¶œì‹œì¼œ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ ì„¤ì •
    alb.ingress.kubernetes.io/certificate-arn: "[green-blog.coì— ëŒ€í•œ SSL ì¸ì¦ì„œì˜ ARNì„ ì—¬ê¸°ì— ì…ë ¥]"
    alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS":443}]'
    alb.ingress.kubernetes.io/actions.ssl-redirect: '{"Type": "redirect", "RedirectConfig": { "Protocol": "HTTPS", "Port": "443", "StatusCode": "HTTP_301"}}'
    external-dns.alpha.kubernetes.io/hostname: "green-blog.co" # ë„ë©”ì¸ ì´ë¦„
spec:
  ingressClassName: alb
  rules:
    - http: # httpëŠ” httpsë¡œ ë¦¬ë‹¤ì´ë ‰ì…˜ ë˜ë¯€ë¡œ, http í•„ë“œë§Œ ì‘ì„±í•œë‹¤.
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: ssl-redirect
                port:
                  name: use-annotation
          - path: /
            pathType: Prefix
            backend:
              service:
                name: istio-ingressgateway
                port:
                  number: 80
          - path: /
            pathType: Prefix
            backend:
              service:
                name: istio-ingressgateway
                port:
                  number: 443
```

ìœ„ <strong>Ingress</strong> ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ì€ ë‹¤ìŒê³¼ ê°™ì€ ê·œì¹™ì„ ì •ì˜í•˜ê³  ìˆë‹¤.

- ALBë¥¼ ì¸í„°ë„·ì— ë…¸ì¶œì‹œì¼œ ì™¸ë¶€ì—ì„œ ì ‘ê·¼í•  ìˆ˜ ìˆë„ë¡ í—ˆìš©
- `green-blog.co` ë„ë©”ì¸ì— ëŒ€í•œ SSL ì¸ì¦ì„œë¥¼ ì‚¬ìš©í•˜ì—¬ HTTPSë¥¼ ì„¤ì •
- HTTPë¥¼ HTTPSë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
- `green-blog.co` ë„ë©”ì¸ì— ëŒ€í•œ ExternalDNS ì„¤ì • ì •ì˜
- ê²½ë¡œì— ë”°ë¼ ìš”ì²­ì„ `istio-ingressgateway` ì„œë¹„ìŠ¤ë¡œ ë¼ìš°íŒ… (ì´í›„ ë‹¤ë£° `Gateway` ì„¤ì •ê³¼ ë°€ì ‘í•œ ê´€ë ¨)

ì´ ì„¤ì •ì„ í†µí•´ ì™¸ë¶€ì—ì„œ `green-blog.co` ë„ë©”ì¸ìœ¼ë¡œ ë“¤ì–´ì˜¤ëŠ” ìš”ì²­ì´ ALBë¥¼ í†µí•´ Istio Ingress Gatewayë¡œ ì „ë‹¬ë˜ë©°, HTTP ìš”ì²­ì€ HTTPSë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ëœë‹¤.


## 5ï¸âƒ£ Gateway, VirtualService ë°°í¬

<strong>`Gateway`</strong>ì™€ <strong>`VirtualService`</strong>ëŠ” `Deployment`, `Service`ì™€ ê°™ì€ ì¿ ë²„ë„¤í‹°ìŠ¤ ë¹ŒíŠ¸ì¸ ë¦¬ì†ŒìŠ¤ê°€ ì•„ë‹ˆë¼ Istioì—ì„œ ì œê³µí•˜ëŠ” <strong>ì¨ë“œíŒŒí‹° ë¦¬ì†ŒìŠ¤</strong>ì´ë‹¤.

ê°ê°ì€ ë‹¤ìŒì˜ ì—­í• ì„ ìˆ˜í–‰í•œë‹¤.

- <strong>Gateway</strong>: ì™¸ë¶€ íŠ¸ë˜í”½ì„ ì „ë‹¬ë°›ì•„ ì´ë¥¼ VirtualServiceë¡œ ì „ë‹¬
- <strong>VirtualService</strong>: Gatewayë¡œë¶€í„° ì „ë‹¬ë°›ì€ íŠ¸ë˜í”½ì„ ë‚´ë¶€ Serviceë¡œ ì „ë‹¬

ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì‘ì„±(ë°°í¬) ìˆœì„œëŠ” `Gateway` â¡ï¸ `VirtualService` ìˆœì´ë‹¤.

### 1. Gateway ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì‘ì„± ë° ë°°í¬

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: Gateway
metadata:
  name: green-blog-co-gateway
  namespace: green-blog-co
spec:
  selector:
    istio: ingressgateway
  servers:
    - port:
        number: 80
        name: http
        protocol: HTTP
      hosts:
        - "green-blog.co"
```

ìœ„ì™€ ê°™ì´ ì‘ì„± í›„ í´ëŸ¬ìŠ¤í„°ì— `Gateway`ë¥¼ ë°°í¬í•˜ë©´ ë¡œë“œ ë°¸ëŸ°ì„œê°€ ìƒì„±ëœë‹¤.

![](https://i.imgur.com/hsr1tVg.png)

ìƒì„±ëœ ë¡œë“œ ë°¸ëŸ°ì„œì˜ `DNS ì´ë¦„`ì€ ì´í›„ VirtualServiceë¥¼ ì‘ì„±í•  ë•Œ í•„ìš”í•˜ë‹¤.

### 2. VirtualService ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ì‘ì„± ë° ë°°í¬

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: green-blog-co-virtual-service
  namespace: green-blog-co
  annotations: # ì „ ë‹¨ê³„ì—ì„œ ìƒì„±ëœ ë¡œë“œ ë°¸ëŸ°ì„œì˜ DNS ì´ë¦„ì„ ì•„ë˜ í•„ë“œì— ì‘ì„±í•œë‹¤.
    external-dns.alpha.kubernetes.io/target: "k8s-istiosys-istioing-5a5c0fc93a-784634683.ap-northeast-2.elb.amazonaws.com"
spec:
  hosts:
    - "green-blog.co"
  gateways:
    - green-blog-co-gateway
  http:
    - match:
      - uri:
          prefix: /
      route:
        - destination:
            host: green-blog-co-service
            port:
               number: 3000 # green-blog-co-serviceì˜ ì—´ë ¤ìˆëŠ” í¬íŠ¸ ë²ˆí˜¸
```

# ë!

ì´ë¥¼ í†µí•´ <u>ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ Github Actions + ECR + EKSë¥¼ ì‚¬ìš©í•˜ì—¬ ë°°í¬</u>í•œ ë‚˜ì˜ ê²½í—˜ì„ ì „ë¶€ ì •ë¦¬í•˜ì˜€ë‹¤.

í”„ë¡ íŠ¸ì—”ë“œ ê°œë°œìê°€ ì‹¤ë¬´ì—ì„œ ì‹¤ì œë¡œ ì¸í”„ë¼ ì„¤ì •ì„ ë‹¤ë£¨ê²Œ ë˜ëŠ” ê²½ìš°ë„ ë“œë¬¼ í…Œì§€ë§Œ, ì´ ê²½í—˜ì„ í†µí•´ì„œ <u>ì‚¬ë‚´ ì›¹ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì–´ë–»ê²Œ ë°°í¬ë˜ëŠ” ì§€ì— ëŒ€í•œ ì „ì²´ì ì¸ íë¦„ì„ ê¹Šê²Œ ì´í•´</u>í•  ìˆ˜ ìˆì—ˆê¸° ë•Œë¬¸ì— ë°°ìš°ë©´ì„œ ì •ë§ ì¦ê±°ì› ë‹¤.

ì‚¬ì‹¤ ì—¬ê¸°ì„œ ëë‚´ê¸°ì—” ì•½ê°„ ì•„ì‰¬ìš´ ë¶€ë¶„ì€ ìˆë‹¤. ì´ ì •ë„ë§Œìœ¼ë¡œëŠ” ì™„ì „í•œ ë°°í¬ ìë™í™”ê°€ ë˜ì§€ ì•Šê¸° ë•Œë¬¸ì´ë‹¤. ì§„ì •í•œ <strong>Push To Deploy</strong>ë¥¼ êµ¬í˜„í•˜ê¸° ìœ„í•´ì„œëŠ” <u>ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ì˜ ë³€ê²½ì„ ê°ì§€í•˜ì—¬ ì´ë¥¼ í´ëŸ¬ìŠ¤í„°ì— ì ìš©</u>í•˜ëŠ” [ArgoCD](https://argo-cd.readthedocs.io/en/stable/)ë¼ëŠ” ë„êµ¬ë„ ë‹¤ë¤„ì•¼ í•˜ê¸° ë•Œë¬¸ì´ë‹¤.

ArgoCDë¥¼ ë‹¤ë¤„ë³¸ ê²½í—˜ì€ ì–¸ì  ê°€ ì—¬ìœ ê°€ ë˜ë©´ ì¶”ê°€ë¡œ ì‘ì„±í•´ë³´ê¸°ë¡œ í•˜ê² ë‹¤.. ğŸ«¡
